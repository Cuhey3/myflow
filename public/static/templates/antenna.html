<!DOCTYPE html>
<html>

<head>
    <title>いろいろ巡回ツール</title>
    <link rel="stylesheet" type="text/css" href="/public/static/style.css">
</head>

<body>
    <h2>いろいろ巡回ツール</h2>
    <form id='createForm'>
        <table>
            <tr>
                <th>タイトル</th>
                <td><input type="text" name="name"></input>
                </td>
            </tr>
            <tr>
                <th>URL</th>
                <td><input type="text" name="url"></input>
                </td>
            </tr>
            <tr>
                <th>メモ</th>
                <td><input type="text" name="memo"></input>
                </td>
            </tr>
            <tr>
                <th>周期</th>
                <td>
                    <select name="span">
                        {% for span_item in span_list %}
                        <option value="{{span_item.key}}">{{span_item.text}}</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <input type="button" value="作成" id='createButton' disabled>
                    <input type="button" value="上書き" id='updateButton' disabled>
                    <input type="hidden" name="id">
                    <input type="hidden" name="current">
                </td>
            </tr>
        </table>
    </form>
    <p>今日のタスク: {{util.count(items, util.is_current_uncomplete)}}<br>その他の未完了タスク: {{util.count(items, util.is_future_uncomplete)}}</p>
    <table id="mainTable">
        <thead>
            <tr>
                <th class="id-th">id</th>
                <th class="span-th">周期</th>
                <th class="past-th">前回</th>
                <th class="next-th">次回</th>
                <th class="title-th">タイトル</th>
                <th class="memo-th">メモ</th>
                <th class="action-th">操作</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr{% if util.is_future(item) or item.span=='complete' %} class="future" {% endif %}>
                <td>{{item.id}}</td>
                <th>{{util.span_key_to_text(item.span)}}</th>
                <td>{{item.past}}</td>
                <td>{{item.next}}</td>
                <td>{% if item.span == 'complete' %}<span>{{item.name | escape}}</span>{% else %}<a href="javascript:void(0)" />{{item.name | escape}}</a>{% endif %}{% if item.url %}
                    <a href="{{item.url}}" class="external" target="_blank"> 　</a>{% endif %}</td>
                <td>{{item.memo}}</td>
                <td>
                    {% if util.is_future(item) or item.get('next', '') == '' or item.span == 'complete' %}
                    <input type="button" value="削除" disabled> {% else %}
                    <input type="button" value="保留" disabled> {% endif %}
                </td>
                </tr>
                {% endfor %}
        </tbody>
    </table>
    <script src='/public/static/myflow-client-util.js'></script>
    <script src='/public/static/myflow-client-core.js'></script>
    <script src='/public/static/myflow-client-consumer.js'></script>
    <script src='/public/static/myflow-client-components.js'></script>
    <script>
        var buttons = selectAll('input[type=button]');
        var options = new Options();
        var mapperCreator = new MapperCreator(function(element) {
            var thtdElements = element.querySelectorAll('th, td');
            return {
                'id': function() {
                    return thtdElements[0].innerText;
                },
                'name': function() {
                    return thtdElements[4].children[0].innerText;
                },
                'url': function() {
                    return getOr(element.querySelector('.external'), 'href', '');
                },
                'memo': function() {
                    return thtdElements[5].innerText;
                },
                'span': function() {
                    return options.getIndexByText(thtdElements[1].innerHTML);
                },
                'current': function() {
                    return thtdElements[3].innerText <= "{{now}}";
                },
                'future': function() {
                    return thtdElements[3].innerText > "{{now}}";
                },
                'finish': function() {
                    return (thtdElements[1].innerText === '一度' || thtdElements[1].innerText === '優先') && thtdElements[3].innerText <= "{{now}}";
                },
                'completed': function() {
                    return thtdElements[1].innerText === '完了';
                },
            }
        }, 'tr');

        new Event('onload', window)
            .to(buttonEnable(buttons))
            .to(log({
                'name': 'ロード完了'
            }));

        new Event('onclick', selectAll('a[href="javascript:void(0)"]'))
            .to(function(exchange) {
                var mapper = mapperCreator.create(exchange);
                mapper.updateExchange(exchange, 'id');
                exchange.setHeader('method', 'update');
                if (mapper.get('finish')) {
                    if (window.confirm('このタスクを完了しますか？')) {
                        exchange.setHeader('finish', 'true');
                        return exchange;
                    }
                }
                else {
                    if (mapper.get('future')) {
                        exchange.setHeader('current', 'true');
                    }
                    return exchange;
                }
            })
            .to(direct('antenna-crud'))

        new Event('onclick', selectAll('.future a.external'))
            .to(function(exchange) {
                var mapper = mapperCreator.create(exchange);
                if (!mapper.get('completed')) {
                    mapper.updateExchange(exchange, 'id');
                    exchange.setHeader('current', 'true');
                    exchange.setHeader('method', 'update');
                    return exchange;
                }
            })
            .to(direct('antenna-crud'));

        new Event('onclick', collectNthChild(selectAll('#mainTable tbody tr'), 'td', 0))
            .to(function(exchange) {
                var mapper = mapperCreator.create(exchange);
                return mapper.updateExchange(exchange, ['name', 'url', 'memo', 'current', 'id', 'span']);
            })
            .to(exchangeToForm(byid('createForm')))
            .to(pageTop());

        new Event('onclick', selectAll('input[value="保留"], input[value="削除"]'))
            .to(buttonEnable(buttons, false))
            .to(function(exchange) {
                var method = exchange.getElement().value === '保留' ? 'update' : 'delete';
                var mapper = mapperCreator.create(exchange);
                mapper.updateExchange(exchange, 'id')
                exchange.setHeader('method', method);
                if (method === 'update') {
                    exchange.setHeader('reserve', 'true');
                }
                return exchange;
            })
            .to(function(exchange) {
                if (exchange.getHeader('method') === 'delete') {
                    if (window.confirm(exchange.getHeader('id') + '番を削除します。')) {
                        return exchange;
                    }
                    else {
                        buttonEnable(buttons)(exchange)
                    }
                }
                else {
                    return exchange;
                }
            })
            .to(direct('antenna-crud'))

        new Event('onclick', selectAll('input[value="上書き"], input[value="作成"]'))
            .to(buttonEnable(buttons, false))
            .to(formToExchange(byid('createForm')))
            .to(function(exchange) {
                if (exchange.getHeader('id') && exchange.getElement().id == 'updateButton') {
                    if (window.confirm(exchange.getHeader('id') + '番を上書きしますか？')) {
                        exchange.setHeader('method', 'update');
                        return exchange;
                    }
                    else {
                        buttonEnable(buttons)(exchange)
                    }
                }
                else {
                    delete exchange.getHeaders()['id'];
                    exchange.setHeader('method', 'create');
                    return exchange;
                }
            })
            .to(function(exchange) {
                var name = exchange.getHeader('name');
                if (!name) {
                    alert('タイトルは必須です。');
                    buttonEnable(buttons)(exchange);
                }
                else {
                    return exchange;
                }
            })
            .to(direct('antenna-crud'))

        new RouteId('antenna-crud')
            .task(request('/antenna-exchange'))
            .to(pageReload());
    </script>
</body>

</html>
