<html>

<head>
    <title>いろいろ巡回ツール</title>
    <script>
        function reload(id, current) {
            var url = '/antenna?method=update&id=' + id;
            if (current) {
                url += '&current=true';
            }
            document.location.href = url;
        }

        function load(id) {
            var now = "{{now}}";
            var row = document.getElementById('tr-id-' + id);
            if (row.children[4].children.length > 0) {
                document.getElementsByName('name')[0].value = row.children[4].children[0].text;
            }
            else {
                document.getElementsByName('name')[0].value = row.children[4].innerHTML;
                if (row.children[5].children.length > 0) {
                }
            }
            var link = row.querySelector('.external')
            if(link){
                document.getElementsByName('url')[0].value = link.href
            }
            document.getElementsByName('memo')[0].value = row.children[5].innerText
            var next = row.children[3].innerHTML;
            document.getElementsByName('current')[0].value = next <= now;
            document.getElementsByName('id')[0].value = id;
            var expression = row.children[1].innerHTML;
            var options = document.getElementsByTagName('option');
            for (var i = 0; i < options.length; i++) {
                if (options[i].innerHTML == expression) {
                    document.getElementsByName('span')[0].selectedIndex = i;
                }
            }
            window.scrollTo(0, 0);
        }

        function finish(id) {
            if (window.confirm('このタスクを完了しますか？')) {
                document.location.href = '/antenna?method=update&id=' + id + '&finish=true';
            }
        }
    </script>
    <style>
        table {
            margin: 10px;
        }
        
        table,
        th,
        td {
            padding: 4px;
            border: 1px solid #666;
            border-collapse: collapse;
        }
        
        .future {
            background-color: #ccc;
        }
        .external{
            background-image: url('/public/static/external-link.svg');
            background-repeat: no-repeat;
            background-size: 16px;
            background-position: center;
            text-decoration: none;
        }
    </style>
</head>

<body>
    <h2>いろいろ巡回ツール</h2>
    <form id='createForm'>
        <table>
            <tr>
                <th>タイトル</th>
                <td><input type="text" name="name"></input>
                </td>
            </tr>
            <tr>
                <th>URL</th>
                <td><input type="text" name="url"></input>
                </td>
            </tr>
            <tr>
                <th>メモ</th>
                <td><input type="text" name="memo"></input>
                </td>
            </tr>
            <tr>
                <th>周期</th>
                <td>
                    <select name="span">
                        {% for span_item in span_list %}
                        <option value="{{span_item.key}}">{{span_item.text}}</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <input type="button" value="作成" id='createButton' disabled>
                    <input type="button" value="上書き" id='updateButton' disabled>
                    <input type="hidden" name="id">
                    <input type="hidden" name="current">
                </td>
            </tr>
        </table>
    </form>
    <p>今日のタスク: {{util.count(items, util.is_current_uncomplete)}}<br>その他の未完了タスク: {{util.count(items, util.is_future_uncomplete)}}</p>
    <table id="mainTable">
        <thead>
            <tr>
                <th>id</th>
                <th>周期</th>
                <th>前回</th>
                <th>次回</th>
                <th>タイトル</th>
                <th>メモ</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr id="tr-id-{{item.id}}" {% if util.is_future(item) or item.span=='complete' %} class="future" {% endif %}>
                <td onclick="load({{item.id}})">{{item.id}}</td>
                <th>{{util.span_key_to_text(item.span)}}</th>
                <td>{{item.past}}</td>
                <td>{% if item.next %}{{item.next}}{% endif %}</td>
                <td>{% if item.span == 'complete' %}{{item.name | escape}}{% else %}<a href="javascript:void(0)" onclick='setTimeout({% if item.span == "once" and util.is_current(item) %}finish("{{item.id}}"){% else %}reload("{{item.id | escape}}", {% if util.is_future(item) %}true{% else %}false{% endif %}){% endif %}, 10)'>{{item.name | escape}}</a>{% endif %}{% if item.url %}<a href="{{item.url}}" class="external" target="_blank"> 　</a>{% endif %}</td>
                <td>{{item.memo}}</td>
                <td>
                    {% if util.is_future(item) or item.get('next', '') == '' or item.span == 'complete' %}
                    <input type="button" value="削除" disabled> {% else %}
                    <input type="button" value="保留" disabled> {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <script src='/public/static/myflow-client-core.js'></script>
    <script src='/public/static/myflow-client-consumer.js'></script>
    <script src='/public/static/myflow-client-components.js'></script>
    <script src='/public/static/myflow-client-util.js'></script>
    <script>
        var links = document.querySelectorAll('a[href="javascript:void(0)"]');
        var idTdElements = []
        document.querySelectorAll('#mainTable tbody tr').forEach(function(element){
            idTdElements.push(element.querySelector('td'))
        })
        var buttons = document.querySelectorAll('input[type=button]');
        
        new Event('onload', window)
            .to(buttonEnable(buttons))
            .to(log({
                'name': 'ロード完了'
            }));
/*
        new Event('onclick', links)
            .to(log({'name': 'links'}));
            
        new Event('onclick', idTdElements)
            .to(log({'name': 'idtd'}))
            .to(function(exchange){
                var now = "{{now}}";
                var id = exchange.getElement().innerText;
                var row = exchange.getElement().parentNode;
                // TBD
            });
        */
        new Event('onclick', document.querySelectorAll('input[value="保留"]'))
            .to(buttonEnable(buttons, false))
            .to(function(exchange){
                var id = exchange.getElement().parentNode.parentNode.querySelector('td').innerText;
                exchange.setHeader('id', id);
                exchange.setHeader('method', 'update');
                exchange.setHeader('reserve', 'true');
                return exchange
            })
            .to(request('/antenna-exchange'));

        new Event('onclick', document.querySelectorAll('input[value="削除"]'))
            .to(buttonEnable(buttons, false))
            .to(function(exchange){
                var id = exchange.getElement().parentNode.parentNode.querySelector('td').innerText;
                exchange.setHeader('id', id);
                return exchange;
            })
            .to(function(exchange){
                if(window.confirm(exchange.getHeader('id') + '番を削除します。')){
                    exchange.setHeader('method', 'delete');
                    return exchange;
                }
            })
            .to(request('/antenna-exchange'));
            
        new Event('onclick', [document.querySelector('input[value="上書き"]'),document.querySelector('input[value="作成"]')])
            .to(buttonEnable(buttons, false))
            .to(formToExchange(byid('createForm')))
            .to(function(exchange) {
                if (exchange.getHeader('id') && exchange.getElement().id == 'updateButton') {
                    if (window.confirm(exchange.getHeader('id') + '番を上書きしますか？')) {
                        exchange.setHeader('method', 'update');
                        return exchange;
                    }else{
                        buttonEnable(buttons)(exchange)
                    }
                }
                else {
                    delete exchange.getHeaders()['id'];
                    exchange.setHeader('method', 'create');
                    return exchange;
                }
            })
            .to(function(exchange) {
                var name = exchange.getHeader('name');
                if (!name) {
                    alert('タイトルは必須です。');
                    buttonEnable(buttons)(exchange);
                }
                else {
                    return exchange;
                }
            })
            .to(log({
                'name': 'これから送る',
                'header': true
            }))
            .to(request('/antenna-exchange'));

        new Reply('/antenna-exchange')
            .to(log({
                'name': '送られてきた',
                'body': true,
                'header': true
            }))
            .to(pageReload());
    </script>
</body>

</html>
